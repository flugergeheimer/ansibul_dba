---
# playbooks/pgcompact.yml
- name: Сжатие таблиц PostgreSQL с помощью pgcompacttable
  hosts: postgres_servers
  gather_facts: yes

  vars:
    pgcompact_path: /tmp/pgcompacttable
    pgcompact_options: "--verbose --force"

  tasks:
    # ========== 1. Собрать информацию о пакетах ==========
    - name: Собрать информацию об установленных пакетах
      ansible.builtin.package_facts:
        manager: auto

    # ========== 2. Проверка Perl зависимостей ==========
    - name: Проверить Perl зависимости для Ubuntu/Debian
      ansible.builtin.fail:
        msg: |
          Для Ubuntu/Debian требуются пакеты:
          - libdbi-perl
          - libdbd-pg-perl
          
          Установите вручную:
          sudo apt update && sudo apt install libdbi-perl libdbd-pg-perl
      when:
        - ansible_os_family == "Debian"
        - not ('libdbi-perl' in ansible_facts.packages)
        - not ('libdbd-pg-perl' in ansible_facts.packages)


   # ========== 3. Установить psycopg2 для модулей PostgreSQL ==========
#    - name: Установить psycopg2
#      ansible.builtin.apt:
#        name: python3-psycopg2
#        state: present
#        update_cache: yes
#      when: ansible_os_family == "Debian"


    # ========== 2. Установить psycopg2 для Python 3.13 ==========
    - name: Установить pip если нет
      ansible.builtin.apt:
        name: python3-pip
        state: present
      when: ansible_os_family == "Debian"
    
    - name: Установить psycopg2-binary через pip
      ansible.builtin.pip:
        name: psycopg2-binary
        executable: pip3      


    # ========== 4. Проверить наличие задач ==========
    - name: Проверить что есть задачи для выполнения
      ansible.builtin.fail:
        msg: |
          Нет задач для сжатия!
          
          Добавьте в инвентарь для {{ inventory_hostname }}:
          pg_database: имя_бд
          target_table: имя_таблицы
          pg_port: 5432 (опционально)
          schema: public (опционально)
      when: 
        - pg_database is not defined
        - target_table is not defined

    # ========== 5. Настройка переменных ==========
    - name: Установить переменные для подключения
      ansible.builtin.set_fact:
        current_db: "{{ pg_database }}"
        current_table: "{{ target_table }}"
        current_port: "{{ pg_port | default(5432) }}"
        current_schema: "{{ schema | default('public') }}"
        current_host: "{{ pg_host | default(ansible_host) }}"
        current_user: "{{ pg_user | default('postgres') }}"

    # ========== 6. Проверка подключения к БД ==========
    - name: Проверить доступность PostgreSQL
      community.postgresql.postgresql_ping:
        login_host: "{{ current_host }}"
        login_port: "{{ current_port }}"
        login_user: "{{ current_user }}"
        login_password: "{{ pg_password | default(omit) }}"
      register: pg_connect

    - name: Выйти если нет подключения к БД
      ansible.builtin.fail:
        msg: "Нет подключения к PostgreSQL {{ current_host }}:{{ current_port }}"
      when: not pg_connect.is_available

    # ========== 7. Проверка существования таблицы ==========
    - name: Проверить существование таблицы
      community.postgresql.postgresql_query:
        query: |
          SELECT EXISTS(
            SELECT 1 FROM information_schema.tables
            WHERE table_schema = '{{ current_schema }}'
            AND table_name = '{{ current_table }}'
          )
        login_host: "{{ current_host }}"
        login_port: "{{ current_port }}"
        login_user: "{{ current_user }}"
        login_password: "{{ pg_password | default(omit) }}"
        database: "{{ current_db }}"
      register: table_exists

    - name: Выйти если таблицы нет
      ansible.builtin.fail:
        msg: "Таблица {{ current_schema }}.{{ current_table }} не существует в БД {{ current_db }}"
      when: not table_exists.query_result[0].exists

    # ========== 8. Проверка и установка расширения pgstattuple ==========
    - name: Проверить наличие расширения pgstattuple
      community.postgresql.postgresql_query:
        query: "SELECT EXISTS(SELECT 1 FROM pg_extension WHERE extname = 'pgstattuple')"
        login_host: "{{ current_host }}"
        login_port: "{{ current_port }}"
        login_user: "{{ current_user }}"
        login_password: "{{ pg_password | default(omit) }}"
        database: "{{ current_db }}"
      register: extension_exists
      changed_when: false

    - name: Установить расширение pgstattuple (если отсутствует)
      community.postgresql.postgresql_ext:
        name: pgstattuple
        database: "{{ current_db }}"
        login_host: "{{ current_host }}"
        login_port: "{{ current_port }}"
        login_user: "{{ current_user }}"
        login_password: "{{ pg_password | default(omit) }}"
        state: present
      when: not extension_exists.query_result[0].exists

    # ========== 9. Скачивание утилиты pgcompacttable ==========
    - name: Проверить наличие pgcompacttable
      ansible.builtin.stat:
        path: "{{ pgcompact_path }}"
      register: pgcompact_bin

    - name: Скачать pgcompacttable (только если отсутствует)
      ansible.builtin.get_url:
        url: "https://raw.githubusercontent.com/dataegret/pgcompacttable/master/bin/pgcompacttable"
        dest: "{{ pgcompact_path }}"
        mode: "0755"
        force: no
        timeout: 30
      when: not pgcompact_bin.stat.exists

    # ========== 10. Запуск pgcompacttable ==========
    - name: Запустить сжатие таблицы
      ansible.builtin.command:
        cmd: |
          {{ pgcompact_path }} \
            -d {{ current_db }} \
            -t {{ current_schema }}.{{ current_table }} \
            --host {{ current_host }} \
            --port {{ current_port }} \
            {{ pgcompact_options }}
      environment:
        PGUSER: "{{ current_user }}"
        PGPASSWORD: "{{ pg_password | default(omit) }}"
        PGHOST: "{{ current_host }}"
        PGPORT: "{{ current_port }}"
      async: 3600
      poll: 30
      register: compact_result

    # ========== 11. Отчёт ==========
    - name: Показать результат
      ansible.builtin.debug:
        msg: |
          =========================================
          РЕЗУЛЬТАТ СЖАТИЯ:
          Хост: {{ inventory_hostname }}
          База данных: {{ current_db }}:{{ current_port }}
          Таблица: {{ current_schema }}.{{ current_table }}
          Статус: {{ 'УСПЕШНО' if compact_result.rc == 0 else 'ОШИБКА' }}
          =========================================
          Вывод: {{ compact_result.stdout_lines | default([]) }}
          Ошибки: {{ compact_result.stderr_lines | default([]) }}
          =========================================
