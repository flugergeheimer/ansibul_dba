---
# playbooks/pgcompact.yml
- name: Сжатие таблиц PostgreSQL с помощью pgcompacttable
  hosts: postgres_servers
  gather_facts: yes

  vars:
    pgcompact_path: /tmp/pgcompacttable
    pgcompact_options: "--verbose --force"

  tasks:
    # ========== 1. Собрать информацию о пакетах ==========
    - name: Собрать информацию об установленных пакетах
      ansible.builtin.package_facts:
        manager: auto

    # ========== 2. Проверка Perl зависимостей ==========
    - name: Проверить Perl зависимости для Ubuntu/Debian
      ansible.builtin.fail:
        msg: |
          Для Ubuntu/Debian требуются пакеты:
          - libdbi-perl
          - libdbd-pg-perl
          
          Установите вручную:
          sudo apt update && sudo apt install libdbi-perl libdbd-pg-perl
      when:
        - ansible_os_family == "Debian"
        - not ('libdbi-perl' in ansible_facts.packages)
        - not ('libdbd-pg-perl' in ansible_facts.packages)


    # ========== 3. Проверка установки psycopg2 ==========
    - name: Проверить что psycopg2 установлен
      ansible.builtin.shell:
        cmd: "python3 -c 'import psycopg2'"
      register: psycopg_check
      changed_when: false
      ignore_errors: true

    - name: Выйти если psycopg2 не установлен
      ansible.builtin.fail:
        msg: |
          psycopg2 не установлен!
          
          Установите на {{ inventory_hostname }}:
          sudo apt install python3-psycopg2
      when: psycopg_check.rc != 0


    # ========== 4. Проверить наличие задач ==========
    - name: Проверить что есть задачи для выполнения
      ansible.builtin.fail:
        msg: |
          Нет задач для сжатия!
          
          Добавьте в инвентарь для {{ inventory_hostname }}:
          pg_database: имя_бд
          target_table: имя_таблицы
          pg_port: 5432 (опционально)
          schema: public (опционально)
      when: 
        - pg_database is not defined
        - target_table is not defined

    # ========== 5. Настройка переменных ==========
    - name: Установить переменные для подключения
      ansible.builtin.set_fact:
        current_db: "{{ pg_database }}"
        current_table: "{{ target_table }}"
        current_port: "{{ pg_port | default(5432) }}"
        current_schema: "{{ schema | default('public') }}"
        current_host: "{{ pg_host | default(ansible_host) }}"
        current_user: "{{ pg_user | default('postgres') }}"

    # ========== 6. Проверка подключения к БД ==========
    #- name: Проверить доступность PostgreSQL
    #  community.postgresql.postgresql_ping:
    #    login_host: "{{ current_host }}"
    #    login_port: "{{ current_port }}"
    #    login_user: "{{ current_user }}"
    #    login_password: "{{ pg_password | default(omit) }}"
    ##  register: pg_connect
    #
#
    #- name: Выйти если нет подключения к БД
    #  ansible.builtin.fail:
    #    msg: "Нет подключения к PostgreSQL {{ current_host }}:{{ current_port }}"
    #  when: not pg_connect.is_available
#

    # ========== 6. Проверка подключения к БД через postgres пользователя ==========
    - name: Проверить доступность PostgreSQL (через postgres)
      become: yes
      become_user: postgres
      community.postgresql.postgresql_ping:
        login_unix_socket: "/var/run/postgresql"
        login_user: postgres
        db: postgres
      register: pg_connect
      changed_when: false

    - name: Выйти если нет подключения к БД
      ansible.builtin.fail:
        msg: "Нет локального подключения к PostgreSQL от пользователя postgres"
      when: not pg_connect.is_available

      

   # # ========== 7. Проверка существования таблицы ==========
   # - name: Проверить существование таблицы
   #   community.postgresql.postgresql_query:
   #     query: |
   #       SELECT EXISTS(
   #         SELECT 1 FROM information_schema.tables
   #         WHERE table_schema = '{{ current_schema }}'
   #         AND table_name = '{{ current_table }}'
   #       )
   #     login_host: "{{ current_host }}"
   #     login_port: "{{ current_port }}"
   #     login_user: "{{ current_user }}"
   #     login_password: "{{ pg_password | default(omit) }}"
   #     login_db: "{{ current_db }}"
   #   register: table_exists
#
   # - name: Выйти если таблицы нет
   #   ansible.builtin.fail:
   #     msg: "Таблица {{ current_schema }}.{{ current_table }} не существует в БД {{ current_db }}"
   #   when: not table_exists.query_result[0].exists

    # ========== 7. Проверка существования таблицы ==========
    - name: Проверить существование таблицы {{ current_schema }}.{{ current_table }}
      become: yes
      become_user: postgres
      community.postgresql.postgresql_query:
        query: |
          SELECT EXISTS(
            SELECT 1 FROM information_schema.tables
            WHERE table_schema = '{{ current_schema }}'
            AND table_name = '{{ current_table }}'
          )
        login_unix_socket: "/var/run/postgresql"
        login_user: postgres
        login_db: "{{ current_db }}"
      register: table_exists

    - name: Выйти если таблицы нет
      ansible.builtin.fail:
        msg: "Таблица {{ current_schema }}.{{ current_table }} не существует в БД {{ current_db }}"
      when: not table_exists.query_result[0].exists





   # # ========== 8. Проверка и установка расширения pgstattuple ==========
   # - name: Проверить наличие расширения pgstattuple
   #   community.postgresql.postgresql_query:
   #     query: "SELECT EXISTS(SELECT 1 FROM pg_extension WHERE extname = 'pgstattuple')"
   #     login_host: "{{ current_host }}"
   #     login_port: "{{ current_port }}"
   #     login_user: "{{ current_user }}"
   #     login_password: "{{ pg_password | default(omit) }}"
   #     login_db: "{{ current_db }}"
   #   register: extension_exists
   #   changed_when: false
#
   # - name: Установить расширение pgstattuple (если отсутствует)
   #   community.postgresql.postgresql_ext:
   #     name: pgstattuple
   #     database: "{{ current_db }}"
   #     login_host: "{{ current_host }}"
   #     login_port: "{{ current_port }}"
   #     login_user: "{{ current_user }}"
   #     login_password: "{{ pg_password | default(omit) }}"
   #     state: present
   #   when: not extension_exists.query_result[0].exists  
  
    # ========== 8. Проверка и установка расширения pgstattuple ==========
    - name: Проверить наличие расширения pgstattuple
      become: yes
      become_user: postgres
      community.postgresql.postgresql_query:
        query: "SELECT EXISTS(SELECT 1 FROM pg_extension WHERE extname = 'pgstattuple') AS ext_exists"
        login_unix_socket: "/var/run/postgresql"
        login_user: postgres
        login_db: "{{ current_db }}"
      register: extension_exists
      changed_when: false

    - name: Установить расширение pgstattuple (если отсутствует)
      become: yes
      become_user: postgres
      community.postgresql.postgresql_ext:
        name: pgstattuple
        db: "{{ current_db }}"
        login_unix_socket: "/var/run/postgresql"
        login_user: postgres
        state: present
      when: not extension_exists.query_result[0].ext_exists



    # ========== 9. Скачивание утилиты pgcompacttable ==========
    - name: Проверить наличие pgcompacttable
      ansible.builtin.stat:
        path: "{{ pgcompact_path }}"
      register: pgcompact_bin

    - name: Скачать pgcompacttable (только если отсутствует)
      ansible.builtin.get_url:
        url: "https://raw.githubusercontent.com/dataegret/pgcompacttable/master/bin/pgcompacttable"
        dest: "{{ pgcompact_path }}"
        mode: "0755"
        force: no
        timeout: 30
      when: not pgcompact_bin.stat.exists

 #  # ========== 10. Запуск pgcompacttable ==========
 #  - name: Показать параметры подключения
 #    ansible.builtin.debug:
 #      msg: |
 #        Будут использованы:
 #        Пользователь: {{ current_user }}
 #        Хост: {{ current_host }}
 #        Порт: {{ current_port }}
 #        БД: {{ current_db }}

 #  - name: Запустить сжатие таблицы
 #    ansible.builtin.command:
 #      cmd: |
 #        {{ pgcompact_path }} \
 #          -d {{ current_db }} \
 #          -t {{ current_schema }}.{{ current_table }} \
 #          --host {{ current_host }} \
 #          --port {{ current_port }} \
 #          --user {{ current_user }} \
 #          {{ pgcompact_options }}
 #    environment:
 #      PGPASSWORD: "{{ pg_password | default(omit) }}"
 #    async: 3600
 #    poll: 30
 #    register: compact_result

    # ========== 10. Запуск pgcompacttable ==========
    - name: Показать параметры подключения
      ansible.builtin.debug:
        msg: |
          Будут использованы:
          Пользователь: postgres
          Подключение: локальный socket (/var/run/postgresql)
          БД: {{ current_db }}
          Таблица: {{ current_schema }}.{{ current_table }}
          Режим: sudo -u postgres

    - name: Запустить сжатие таблицы от пользователя postgres
      become: yes
      become_user: postgres
      ansible.builtin.command:
        cmd: |
          {{ pgcompact_path }} \
            -d {{ current_db }} \
            -t {{ current_schema }}.{{ current_table }} \
            --host localhost \
            --port {{ current_port }} \
            {{ pgcompact_options }}
      async: 3600
      poll: 30
      register: compact_result



    # ========== 11. Отчёт ==========

    - name: Основная информация
      ansible.builtin.debug:
        msg: |
          СЖАТИЕ ТАБЛИЦЫ ЗАВЕРШЕНО
          Хост: {{ inventory_hostname }}
          База: {{ current_db }}:{{ current_port }}
          Таблица: {{ current_schema }}.{{ current_table }}
          Статус: {{ '✅ УСПЕШНО' if compact_result.rc == 0 else '❌ ОШИБКА' }}

    - name: Вывод команды
      ansible.builtin.debug:
        msg: "{{ item }}"
      loop: "{{ compact_result.stdout_lines }}"
      when: compact_result.stdout_lines | length > 0
      loop_control:
        label: "Вывод"

    - name: Ошибки команды
      ansible.builtin.debug:
        msg: "{{ item }}"
      loop: "{{ compact_result.stderr_lines }}"
      when: compact_result.stderr_lines | length > 0
      loop_control:
        label: "Ошибка"

    - name: Итоговый разделитель
      ansible.builtin.debug:
        msg: "════════════════════════════════════════"
